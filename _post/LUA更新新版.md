#LUA更新流程：
[toc]

##功能目标：发布补丁包/紧急修复
	LUA代码需要紧急发布时，由后台派发订阅信息，客户端进行LUA代码更新。

###更新时机：
	后台通过订阅通道下发时（认证结束），客户端启动下载模块。
	下载完成直接覆盖沙盒中的LUA文件。
	下一次启动时 委托模块启动（通常情况下是app重启）会使用更新后的LUA文件。

###影响范围：
	用户群体影响：由后台决定下发时机, 和影响的版本范围 进行区分。
	客户端影响：下载时少量占用性能，重启及之后没有影响。
	服务器性能：补丁包主要由差异包组成，总大小不超过200kb，其他影响需要统计。（@陈嗣雄）

##客户端流程图：

![LUA更新new.jpg.jpeg](.\LUA更新new.jpg.jpeg)

##各部门负责内容
###后台：
1. 后台控制订阅派发的时机和内容。
2. 后台派发的数据需要包含以下内容：
	* 需要更新到的LUA版本
	* 需要更新的客户端起始版本号
	* MD5值
3. 后台提供脚本, 将LUA代码密文打包并上传到对应服务器上。
4. 补丁包的管理。

###客户端：
1. 客户端注册对应的订阅。
2. 客户端收到订阅信息后，进行数据解析，符合条件的去下载对应的补丁包。
3. 客户端本地额外维护一份LUA版本, 该版本由写在文件中，更新LUA时该文件也会更新。
4. 客户端负责将LUA代码加密并且将明文和密文都提交到GIT上。 （该步骤建议商榷，建议交给明文加密也直接交给脚本执行，客户端只上传明文）

###主站：
1. 每次LUA有代码改动时（包括正常升级和补丁包）,主站提供LUA明文代码 交给客户端。

##环境部署：
###GIT：
由客户端提供， 暂时由客户端负责代码的上传。
其中正式分支 每次LUA有代码改动时（包括正常升级和补丁包） 都要将相关代码提交一份正式分支。
正式分支代码提交后, 自动进行版本递增生成版本号文件，并调用JENKINS相关脚本 将密文和版本信息一起打包生成 gzip压缩包上传到服务器上。
测试分支同上，但是只会上传到测试服务器上。

###JENKINS：
负责将指定的git提交打包成gzip包
需要区分测试和正式

另外手机炒股客户端打包的时候需要会从LUA工程中拿到对应的版本号，并且保存在本地，供后续需要升级补丁时读取。

###其他
版本发布， 测试环境由 后台控制，正式环境由运维控制。

##例子
###正常升级流程
1. LUA有所更新，主站LUA代码编辑完成后，通过内网将LUA代码给客户端。
2. 客户端将lua代码打包进入 主站SDK，进行相关测试。
3. 测试完成后, 再将LUA代码的明文和密文提交到LUA工程中，通过JENKINS生成对应的版本信息和gzip包,但是不进行发布。
4. 之后客户端打包时，会从LUA工程中取到 对应的LUA版本信息，保存在本地。

###补丁发布流程
1. LUA代码需要紧急更新时, 主站LUA代码编辑完成后，通过内网将LUA代码给客户端。
2. 客户端 将LUA代码明文和密文 提交到LUA工程中的测试分支，通过JENKINS生成对应的版本信息和gzip包, 并自动发布到测试后台上。
3. 测试在测试后台进行测试，确认功能无误后，通知客户端，客户端将测试分支代码提交到正式分支。
4. 由测试在预发布环境进行测试。
5. 由 主站开发 和 产品确认 需要修复的版本范围，并告知 后台和运维，进行发布。
6. 由 后台和运维统计 成功修复的用户数量， 和修复率。

###客户端收到订阅场景
1. 客户端收到订阅
2. 客户端解析订阅中的数据， 拿到
	* 生效的起始客户端版本号
	* 补丁包的 LUA版本号
3. 假如客户端满足以下所有条件时， 客户端去下载LUA补丁包
	* 客户端版本号大于起始版本号
	* 客户端的LUA版本号小于LUA补丁包
4. 客户端下载成功后， 覆盖沙盒（本地）中的LUA文件 及LUA版本文件。
5. 重新启动后 或者 重新加载 交易主站直连模块时， 使用补丁包中的LUA代码。

##该流程缺陷
* LUA工程代码太多，参与管理的人员太多。
		按照该流程，lua代码一共有3个工程，
        	①主站LUA代码 
            ②客户端交易直连方案 LUA代码 
            ③LUA更新补丁包 LUA代码。
		其中 ②③工程 代码需要保持完全一致。 ①由主站修改并管理， ②③都是主站提供，但是由客户端相关人员进行管理。
* 需要重启后才能启动修复，不是实时修复。
	